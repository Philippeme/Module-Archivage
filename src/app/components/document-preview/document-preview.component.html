<div class="document-preview-overlay" *ngIf="document">
    <div class="document-preview-container">
        <div class="document-preview-header">
            <h5 class="mb-0">
                {{ selectedVersion?.originalName }}
                <ng-container *ngIf="selectedVersion as version">
                    <span class="badge bg-secondary ms-2" *ngIf="version.version > 1">v{{ version.version }}</span>
                </ng-container>
            </h5>
            <div class="document-preview-actions">
                <button class="btn btn-sm" [ngClass]="isPreviewMode ? 'btn-outline-info' : 'btn-info'"
                    (click)="toggleViewMode()">
                    <i class="bi" [ngClass]="isPreviewMode ? 'bi-file-earmark-text' : 'bi-file-earmark'"></i>
                    {{ isPreviewMode ? 'Voir document complet' : 'Vue légère' }}
                </button>
                <button class="btn btn-sm btn-outline-primary ms-2" (click)="downloadCurrentDocument()">
                    <i class="bi bi-download"></i> Télécharger
                </button>
                <button class="btn btn-sm btn-outline-success ms-2" (click)="shareCurrentDocument()">
                    <i class="bi bi-share"></i> Partager
                </button>
                <button class="btn btn-sm ms-2" [ngClass]="isFavorite() ? 'btn-warning' : 'btn-outline-warning'"
                    (click)="toggleFavorite()">
                    <i class="bi" [ngClass]="isFavorite() ? 'bi-star-fill' : 'bi-star'"></i>
                    {{ isFavorite() ? 'Favori' : 'Ajouter aux favoris' }}
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-2" (click)="closePreview()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <div class="document-preview-content">
            <div class="document-sidebar">
                <!-- Onglets pour la navigation -->
                <ul class="nav nav-tabs nav-fill">
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeTab === 'info'" (click)="setActiveTab('info')">
                            <i class="bi bi-info-circle me-1"></i>
                            Informations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeTab === 'comments'"
                            (click)="setActiveTab('comments')">
                            <i class="bi bi-chat-left-text me-1"></i>
                            Commentaires
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeTab === 'history'" (click)="setActiveTab('history')">
                            <i class="bi bi-clock-history me-1"></i>
                            Historique
                        </a>
                    </li>
                </ul>

                <!-- Onglet Informations -->
                <div *ngIf="activeTab === 'info'" class="tab-content">
                    <div class="document-metadata">
                        <h6>Informations</h6>
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Type</dt>
                            <dd class="col-sm-7">{{ selectedVersion?.type }}</dd>

                            <dt class="col-sm-5">Date de création</dt>
                            <dd class="col-sm-7">{{ selectedVersion?.creationDate | date:'dd/MM/yyyy' }}</dd>

                            <dt class="col-sm-5">Dernière modification</dt>
                            <dd class="col-sm-7">{{ selectedVersion?.lastModificationDate | date:'dd/MM/yyyy' }}</dd>

                            <dt class="col-sm-5">Source</dt>
                            <dd class="col-sm-7">{{ selectedVersion?.sourceInstitution }}</dd>

                            <dt class="col-sm-5">Concerné</dt>
                            <dd class="col-sm-7">
                                {{ selectedVersion?.concernedPerson1 }}
                                <ng-container *ngIf="selectedVersion?.concernedPerson2">
                                    <br>{{ selectedVersion?.concernedPerson2 }}
                                </ng-container>
                            </dd>

                            <dt class="col-sm-5">Taille</dt>
                            <dd class="col-sm-7">{{ selectedVersion?.size | number }} Ko</dd>
                        </dl>
                    </div>

                    <div class="document-versions" *ngIf="documentVersions.length > 1">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Versions</h6>
                            <button class="btn btn-sm btn-outline-primary" (click)="openVersionComparison()"
                                title="Comparer des versions">
                                <i class="bi bi-arrow-left-right"></i>
                            </button>
                        </div>
                        <ul class="list-group">
                            <li *ngFor="let version of documentVersions"
                                class="list-group-item d-flex justify-content-between align-items-center"
                                [class.active]="version.id === selectedVersion?.id" (click)="selectVersion(version)">
                                Version {{ version.version }}
                                <span class="badge bg-primary rounded-pill">
                                    {{ version.lastModificationDate | date:'dd/MM/yyyy' }}
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Onglet Commentaires -->
                <div *ngIf="activeTab === 'comments'" class="tab-content">
                    <app-document-comments [document]="document"></app-document-comments>
                </div>

                <!-- Onglet Historique -->
                <div *ngIf="activeTab === 'history'" class="tab-content">
                    <app-document-history [document]="document"></app-document-history>
                </div>
            </div>

            <div class="document-viewer">
                <div class="spinner-container" *ngIf="isLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>

                <div class="error-container" *ngIf="errorMessage">
                    <div class="alert alert-danger">
                        {{ errorMessage }}
                    </div>
                </div>

                <iframe *ngIf="pdfUrl && !isLoading && !errorMessage" [src]="pdfUrl" frameborder="0" width="100%"
                    height="100%">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Composant de comparaison de versions -->
    <app-version-comparison *ngIf="showComparisonView" [document]="document" [documentVersions]="documentVersions"
        (close)="closeVersionComparison()">
    </app-version-comparison>

    <app-email-share-modal *ngIf="showShareModal" [document]="selectedVersion" (close)="closeShareModal()"
        (success)="handleShareSuccess($event)">
    </app-email-share-modal>

    <!-- Ajout d'un message de succès pour le partage -->
    <div *ngIf="shareSuccess" class="share-success-notification">
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            {{ shareSuccess }}
        </div>
    </div>
</div>